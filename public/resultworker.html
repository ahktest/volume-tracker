<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <title>Futures PNL Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="favicon.png" type="image/x-icon"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,sans-serif;background:#0b0f14;color:#e5e7eb;min-height:100vh}

    /* ─── Login ─── */
    .login-overlay{position:fixed;inset:0;background:#0b0f14;display:flex;align-items:center;justify-content:center;z-index:999}
    .login-box{background:#111827;padding:40px 36px;border-radius:14px;text-align:center;min-width:320px}
    .login-box h2{margin-bottom:18px;font-size:1.3rem;color:#93c5fd}
    .login-box input{width:100%;padding:12px 14px;border:1px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;font-size:15px;outline:none;margin-bottom:14px}
    .login-box input:focus{border-color:#60a5fa}
    .login-box button{width:100%;padding:12px;background:#2563eb;color:#fff;border:none;border-radius:8px;font-size:15px;cursor:pointer;font-weight:600}
    .login-box button:hover{background:#1d4ed8}
    .login-error{color:#f87171;font-size:13px;margin-top:8px;display:none}

    /* ─── Nav ─── */
    .top-nav{background:#111827;border-bottom:1px solid #1f2937;padding:0 16px;display:flex;align-items:center;gap:6px}
    .top-nav a{color:#9ca3af;text-decoration:none;font-size:13px;padding:12px 16px;border-bottom:2px solid transparent;transition:color .2s,border-color .2s}
    .top-nav a:hover{color:#e5e7eb}
    .top-nav a.active{color:#93c5fd;border-bottom-color:#3b82f6;font-weight:600}

    /* ─── Layout ─── */
    .container{max-width:1200px;margin:0 auto;padding:20px 16px}
    .header-bar{display:flex;align-items:center;justify-content:space-between;padding:16px 0;border-bottom:1px solid #1f2937;margin-bottom:24px}
    .header-bar h1{font-size:1.4rem;color:#93c5fd}
    .header-bar .sub{color:#6b7280;font-size:13px;margin-top:2px}
    .header-bar .logout{padding:6px 14px;background:#374151;color:#9ca3af;border:none;border-radius:6px;cursor:pointer;font-size:13px}
    .header-bar .logout:hover{background:#4b5563;color:#e5e7eb}

    /* ─── Filters ─── */
    .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:20px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;background:#111827;border:1px solid #1f2937;border-radius:10px;font-size:13px;color:#9ca3af}
    .pill select{background:#1f2937;color:#e5e7eb;border:1px solid #374151;border-radius:6px;padding:6px 10px;font-size:13px;outline:none;cursor:pointer}
    .pill select:focus{border-color:#60a5fa}
    .btn-refresh{padding:8px 16px;background:#2563eb;color:#fff;border:none;border-radius:8px;font-size:13px;cursor:pointer;font-weight:600}
    .btn-refresh:hover{background:#1d4ed8}

    /* ─── Cards ─── */
    .card{background:#111827;border-radius:12px;border:1px solid #1f2937;padding:18px 20px;margin-bottom:16px}
    .card h2{font-size:14px;color:#93c5fd;margin-bottom:12px;font-weight:600}

    /* ─── KPI ─── */
    .kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .kpi{background:#0f172a;border:1px solid #1a2332;border-radius:10px;padding:14px 16px}
    .kpi .label{font-size:11px;color:#6b7280;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
    .kpi .value{font-size:1.5rem;font-weight:700}
    .pos{color:#34d399}.neg{color:#f87171}

    /* ─── Grid ─── */
    .grid-2{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}

    /* ─── Chart ─── */
    .chart-wrap{height:380px;margin-top:12px}
    .chart-wrap canvas{width:100%!important;height:100%!important}

    /* ─── Table ─── */
    .table-wrap{overflow-x:auto;border-radius:10px}
    table{width:100%;border-collapse:collapse;min-width:420px;font-size:13px}
    thead th{background:#0f172a;color:#94a3b8;font-weight:600;padding:10px 12px;text-align:left;white-space:nowrap;position:sticky;top:0;border-bottom:1px solid #1f2937}
    tbody td{padding:9px 12px;border-bottom:1px solid #1a2332;white-space:nowrap}
    tr:hover td{background:#0d1320}

    .muted{color:#6b7280;font-size:12px;margin-top:8px}

    /* ─── Responsive ─── */
    @media(max-width:650px){
      .kpi-row{grid-template-columns:1fr}
      .kpi .value{font-size:1.2rem}
    }
  </style>
</head>
<body>

<!-- ═══════ LOGIN ═══════ -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>Futures PNL Dashboard</h2>
    <input type="password" id="passInput" placeholder="Parola" autocomplete="off"/>
    <button onclick="doLogin()">Gir</button>
    <div class="login-error" id="loginErr">Parola yanlis</div>
  </div>
</div>

<!-- ═══════ NAV ═══════ -->
<nav class="top-nav" id="topNav" style="display:none">
  <a href="resultworker.html" class="active">Futures PNL</a>
  <a href="signals.html">Signal Scores</a>
</nav>

<!-- ═══════ MAIN ═══════ -->
<div class="container" id="mainApp" style="display:none">

  <div class="header-bar">
    <div>
      <h1>Futures PNL</h1>
      <div class="sub">Kapanan pozisyonlara gore performans</div>
    </div>
    <button class="logout" onclick="doLogout()">Logout</button>
  </div>

  <div class="filters">
    <span class="pill">
      Range:
      <select id="sinceDays">
        <option value="7">7 gun</option>
        <option value="30" selected>30 gun</option>
        <option value="90">90 gun</option>
        <option value="365">365 gun</option>
        <option value="0">tumu</option>
      </select>
    </span>
    <button class="btn-refresh" id="refreshBtn">Yenile</button>
  </div>

  <!-- 1) Chart + KPI -->
  <div class="card">
    <h2>Kumulatif PNL</h2>
    <div class="kpi-row" style="margin-bottom:14px">
      <div class="kpi">
        <div class="label">Toplam PNL</div>
        <div id="kpiTotalPnl" class="value">—</div>
      </div>
      <div class="kpi">
        <div class="label">Win / Loss</div>
        <div id="kpiWl" class="value">—</div>
      </div>
      <div class="kpi">
        <div class="label">Win Rate</div>
        <div id="kpiWr" class="value">—</div>
      </div>
    </div>
    <div class="chart-wrap">
      <canvas id="pnlChart"></canvas>
    </div>
    <div class="muted">PNL = pnl - funding_fee - commission</div>
  </div>

  <!-- 2) Funding vs Normal -->
  <div class="grid-2">
    <div class="card">
      <h2>Normal (source=normal)</h2>
      <div class="kpi-row">
        <div class="kpi">
          <div class="label">PNL</div>
          <div id="normalPnl" class="value">—</div>
        </div>
        <div class="kpi">
          <div class="label">Win / Loss</div>
          <div id="normalWl" class="value">—</div>
        </div>
        <div class="kpi">
          <div class="label">Win Rate</div>
          <div id="normalWr" class="value">—</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Funding (source=funding)</h2>
      <div class="kpi-row">
        <div class="kpi">
          <div class="label">PNL</div>
          <div id="fundingPnl" class="value">—</div>
        </div>
        <div class="kpi">
          <div class="label">Win / Loss</div>
          <div id="fundingWl" class="value">—</div>
        </div>
        <div class="kpi">
          <div class="label">Win Rate</div>
          <div id="fundingWr" class="value">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 3) Balance degisimi -->
  <div class="card">
    <h2>Total Balance Change</h2>
    <div class="kpi-row">
      <div class="kpi">
        <div class="label">Son 7 gun</div>
        <div id="bal7" class="value">—</div>
      </div>
      <div class="kpi">
        <div class="label">Son 30 gun</div>
        <div id="bal30" class="value">—</div>
      </div>
      <div class="kpi">
        <div class="label">Yillik (YTD)</div>
        <div id="balYtd" class="value">—</div>
      </div>
    </div>
    <div class="muted">total_futures_balance: ilgili periyottaki ilk ve son deger farki</div>
  </div>

  <!-- 4) Gunluk tablo -->
  <div class="card">
    <h2>Gunluk Win/Loss & PNL</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Tarih</th>
            <th>W</th>
            <th>L</th>
            <th>PNL</th>
          </tr>
        </thead>
        <tbody id="dailyBody">
          <tr><td colspan="4" class="muted">Yukleniyor...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 5) Balance Chart -->
  <div class="card">
    <h2>Total Balance (Equity Curve)</h2>
    <div class="chart-wrap">
      <canvas id="balanceChart"></canvas>
    </div>
    <div class="muted">Gunluk kapanislara gore total_futures_balance</div>
  </div>

</div>

<script>
let DASH_KEY = '';

// ─── Login ───
function doLogin() {
  const v = document.getElementById('passInput').value.trim();
  if (!v) return;
  DASH_KEY = v;
  // test API
  fetch('/api/futures-pnl?since_days=7', { headers: { 'x-dash-key': DASH_KEY } })
    .then(r => {
      if (!r.ok) throw new Error();
      document.getElementById('loginOverlay').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      document.getElementById('topNav').style.display = 'flex';
      sessionStorage.setItem('pnl_key', DASH_KEY);
      loadAll().catch(err => console.error(err));
    })
    .catch(() => {
      const el = document.getElementById('loginErr');
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 2500);
    });
}

function doLogout() {
  sessionStorage.removeItem('pnl_key');
  DASH_KEY = '';
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('topNav').style.display = 'none';
  document.getElementById('loginOverlay').style.display = 'flex';
}

// Auto-login
(function() {
  const saved = sessionStorage.getItem('pnl_key');
  if (saved) {
    DASH_KEY = saved;
    document.getElementById('passInput').value = saved;
    doLogin();
  }
  document.getElementById('passInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') doLogin();
  });
})();

// ─── Helpers ───
const el = (id) => document.getElementById(id);

function formatDateTR(d) {
  const date = new Date(d);
  return String(date.getDate()).padStart(2,'0') + '.' + String(date.getMonth()+1).padStart(2,'0') + '.' + date.getFullYear();
}

function formatDateShort(d) {
  const date = new Date(d);
  return String(date.getDate()).padStart(2,'0') + '.' + String(date.getMonth()+1).padStart(2,'0');
}

function fmtNum(n, digits=4) {
  return Number(n || 0).toFixed(digits);
}

function setValue(elm, n, digits=4) {
  const num = Number(n || 0);
  elm.textContent = fmtNum(num, digits);
  elm.className = 'value ' + (num >= 0 ? 'pos' : 'neg');
}

async function apiGet(path) {
  const res = await fetch(path, { headers: { 'x-dash-key': DASH_KEY } });
  if (!res.ok) throw new Error(`API error (${res.status})`);
  return res.json();
}

// ─── Chart theme ───
const chartColors = {
  line: '#60a5fa',
  grid: '#1f2937',
  text: '#6b7280',
  bg: 'rgba(96, 165, 250, 0.08)',
};

function darkScales() {
  return {
    x: {
      ticks: { color: chartColors.text, font: { size: 11 } },
      grid: { color: chartColors.grid },
      title: { display: true, text: 'Tarih', color: chartColors.text }
    },
    y: {
      ticks: { color: chartColors.text, font: { size: 11 } },
      grid: { color: chartColors.grid },
    }
  };
}

// ─── Charts ───
const ctx = document.getElementById('pnlChart').getContext('2d');
let chart;
const balanceCtx = document.getElementById('balanceChart').getContext('2d');
let balanceChart;

function buildChart(labels, cumulative) {
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Cumulative PNL',
        data: cumulative,
        borderColor: chartColors.line,
        backgroundColor: chartColors.bg,
        borderWidth: 2,
        tension: 0.3,
        pointRadius: 0,
        fill: true,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1f2937',
          titleColor: '#e5e7eb',
          bodyColor: '#e5e7eb',
          borderColor: '#374151',
          borderWidth: 1,
          callbacks: {
            title: (items) => formatDateTR(items[0].label),
            label: (item) => `PNL: ${Number(item.raw).toFixed(4)}`
          }
        }
      },
      scales: { ...darkScales(), y: { ...darkScales().y, title: { display: true, text: 'PNL', color: chartColors.text } } }
    }
  });
}

function buildBalanceChart(labels, data) {
  if (balanceChart) balanceChart.destroy();
  balanceChart = new Chart(balanceCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Total Balance',
        data,
        borderColor: '#34d399',
        backgroundColor: 'rgba(52, 211, 153, 0.08)',
        borderWidth: 2,
        tension: 0.25,
        pointRadius: 0,
        fill: true,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1f2937',
          titleColor: '#e5e7eb',
          bodyColor: '#e5e7eb',
          borderColor: '#374151',
          borderWidth: 1,
          callbacks: {
            title: (items) => formatDateTR(items[0].label),
            label: (item) => `Balance: ${Number(item.raw).toFixed(4)}`
          }
        }
      },
      scales: { ...darkScales(), y: { ...darkScales().y, title: { display: true, text: 'Balance', color: chartColors.text } } }
    }
  });
}

// ─── Load ───
async function loadAll() {
  const sinceDays = el('sinceDays').value;

  // 1) Chart + main KPI
  const pnlData = await apiGet(`/api/futures-pnl?since_days=${encodeURIComponent(sinceDays)}`);
  const rows = pnlData.daily || [];
  const stats = pnlData.stats || { wins:0, losses:0, total:0, winRate:0, totalPnl:0 };

  const labels = [];
  let total = 0;
  const cumulative = [];
  for (const r of rows) {
    labels.push(formatDateShort(r.date));
    total += Number(r.pnl || 0);
    cumulative.push(Number(total.toFixed(8)));
  }

  setValue(el('kpiTotalPnl'), total, 4);
  el('kpiWl').textContent = `${stats.wins}W / ${stats.losses}L`;
  el('kpiWr').textContent = `${Number(stats.winRate || 0).toFixed(2)}%`;
  el('kpiWr').className = 'value ' + (Number(stats.winRate) >= 50 ? 'pos' : 'neg');
  buildChart(labels, cumulative);

  // 2) Funding vs Normal
  const sum = await apiGet(`/api/futures-summary?since_days=${encodeURIComponent(sinceDays)}`);
  const bySource = (sum && sum.bySource) ? sum.bySource : {};
  const normal = bySource.normal || { wins:0, losses:0, winRate:0, pnl:0 };
  const funding = bySource.funding || { wins:0, losses:0, winRate:0, pnl:0 };

  setValue(el('normalPnl'), normal.pnl, 4);
  el('normalWl').textContent = `${normal.wins}W / ${normal.losses}L`;
  el('normalWr').textContent = `${Number(normal.winRate || 0).toFixed(2)}%`;
  el('normalWr').className = 'value ' + (Number(normal.winRate) >= 50 ? 'pos' : 'neg');

  setValue(el('fundingPnl'), funding.pnl, 4);
  el('fundingWl').textContent = `${funding.wins}W / ${funding.losses}L`;
  el('fundingWr').textContent = `${Number(funding.winRate || 0).toFixed(2)}%`;
  el('fundingWr').className = 'value ' + (Number(funding.winRate) >= 50 ? 'pos' : 'neg');

  // 3) Balance changes
  const bal = await apiGet('/api/futures-balance-changes');
  setValue(el('bal7'), bal.diff_7d, 4);
  setValue(el('bal30'), bal.diff_30d, 4);
  setValue(el('balYtd'), bal.diff_ytd, 4);

  // 4) Daily table
  const daily = await apiGet(`/api/futures-daily?limit=14`);
  const tbody = el('dailyBody');
  tbody.innerHTML = '';

  // 5) Balance chart
  const balHist = await apiGet('/api/futures-balance-history');
  buildBalanceChart(balHist.map(r => formatDateShort(r.date)), balHist.map(r => r.balance));

  if (!daily.length) {
    tbody.innerHTML = '<tr><td colspan="4" class="muted">Kayit yok</td></tr>';
    return;
  }

  for (const r of daily) {
    const pnl = Number(r.pnl || 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatDateTR(r.date)}</td>
      <td>${Number(r.wins || 0)}</td>
      <td>${Number(r.losses || 0)}</td>
      <td class="${pnl >= 0 ? 'pos' : 'neg'}">${pnl.toFixed(4)}</td>
    `;
    tbody.appendChild(tr);
  }
}

el('refreshBtn').addEventListener('click', () => loadAll().catch(err => alert(err.message)));
el('sinceDays').addEventListener('change', () => loadAll().catch(err => alert(err.message)));
</script>
</body>
</html>
