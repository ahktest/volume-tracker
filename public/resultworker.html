<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Futures PNL Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 24px;
      max-width: 1100px;
    }

    h1 { margin-bottom: 4px; }
    .sub { opacity: 0.7; margin-bottom: 24px; }

    .pnl-box {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-radius: 12px;
      background: #10b9811a;
      margin-bottom: 24px;
    }

    .pnl-box .label {
      font-size: 14px;
      opacity: 0.7;
    }

    .pnl-box .value {
      font-size: 32px;
      font-weight: 700;
    }

    .pnl-positive { color: #10b981; }
    .pnl-negative { color: #ef4444; }

    canvas {
      width: 100% !important;
      height: 420px !important;
    }
  </style>
</head>
<body>

  <h1>Futures PNL</h1>
  <div class="sub">Kapanan pozisyonlara göre toplam performans</div>

  <div class="pnl-box">
    <div>
      <div class="label">Toplam PNL</div>
      <div id="totalPnl" class="value">—</div>
    </div>
  </div>

  <canvas id="pnlChart"></canvas>

  <div class="pnl-box" style="margin-top:12px">
  <div>
    <div class="label">Win / Loss</div>
    <div id="wlText" class="value">—</div>
  </div>
</div>

  <script>
    const totalEl = document.getElementById('totalPnl');
    const ctx = document.getElementById('pnlChart').getContext('2d');

    let chart;

    async function loadPNL() {
  const res = await fetch('/api/futures-pnl');
  const data = await res.json();

  const rows = data.daily || [];
  const stats = data.stats || {};

  if (!rows.length) {
    totalEl.textContent = '0.00';
    return;
  }

  const labels = [];
  let total = 0;
  const cumulative = [];

  for (const r of rows) {
    labels.push(r.date);
    total += Number(r.pnl);
    cumulative.push(total);
  }

  totalEl.textContent = total.toFixed(4);
  totalEl.className = 'value ' + (total >= 0 ? 'pnl-positive' : 'pnl-negative');

  const wlEl = document.getElementById('wlText');
  if (stats.total > 0) {
    wlEl.textContent =
      `${stats.wins}W / ${stats.losses}L  (${stats.winRate}%)`;
  } else {
    wlEl.textContent = '—';
  }

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Toplam PNL',
        data: cumulative,
        borderWidth: 2,
        borderColor: '#10b981',
        tension: 0.25,
        pointRadius: 2,
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: 'Tarih' } },
        y: { title: { display: true, text: 'PNL' } }
      }
    }
  });
}

    loadPNL();
  </script>
</body>
</html>