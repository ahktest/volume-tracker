<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hacim TablolarÄ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-white p-4">
  <h2 class="mb-4">ðŸ“Š Hacim ArtÄ±ÅŸ/DÃ¼ÅŸÃ¼ÅŸ ve Yeni GiriÅŸler</h2>

  <h3>ðŸ”¼ En Ã‡ok Artan Hacimler</h3>
  <table class="table table-dark table-bordered table-striped" id="increaseTable">
    <thead>
      <tr>
        <th>Sembol</th>
        <th>Fiyat</th>
        <th>Son Hacim</th>
        <th>4s Ã–nce</th>
        <th>8s Ã–nce</th>
        <th>ArtÄ±ÅŸ %</th>
        <th>Link</th>
        <th>Tarih</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3 class="mt-5">ðŸ”½ En Ã‡ok DÃ¼ÅŸen Hacimler</h3>
  <table class="table table-dark table-bordered table-striped" id="decreaseTable">
    <thead>
      <tr>
        <th>Sembol</th>
        <th>Fiyat</th>
        <th>Son Hacim</th>
        <th>4s Ã–nce</th>
        <th>8s Ã–nce</th>
        <th>DÃ¼ÅŸÃ¼ÅŸ %</th>
        <th>Link</th>
        <th>Tarih</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3 class="mt-5">ðŸ†• Son 8 Saatte Top200â€™e Girenler</h3>
  <table class="table table-dark table-bordered table-striped" id="newTop200Table">
    <thead>
      <tr>
        <th>Sembol</th>
        <th>Fiyat</th>
        <th>Hacim (4s Ã¶nce)</th>
        <th>Hacim (ÅŸimdi)</th>
        <th>Link</th>
        <th>Tarih</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    fetch('/api/coins')
      .then(res => res.json())
      .then(data => {
        const grouped = {};
        data.forEach(d => {
          if (!grouped[d.symbol]) grouped[d.symbol] = [];
          grouped[d.symbol].push(d);
        });

        const topIncreases = [];
        const topDecreases = [];
        const newEntries = [];

        Object.values(grouped).forEach(coinData => {
          coinData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          const [v0, v1, v2] = coinData;

          // En az 3 veri varsa artÄ±ÅŸ/dÃ¼ÅŸÃ¼ÅŸ hesapla
          if (v0 && v1 && v2) {
            const change = ((v0.volume - v1.volume) / v1.volume) * 100;
            const common = {
              symbol: v0.symbol,
              price: v0.price,
              volume_now: v0.volume,
              volume_4h: v1.volume,
              volume_8h: v2.volume,
              percent: change,
              slug: v0.slug,
              timestamp: v0.timestamp
            };

            if (change > 0) topIncreases.push(common);
            else topDecreases.push(common);
          }

          // EÄŸer sadece son 2 veri varsa, bu yeni girmiÅŸ olabilir
          if (coinData.length === 2) {
            const [latest, earlier] = coinData;
            const hoursDiff = Math.abs((new Date(latest.timestamp) - new Date(earlier.timestamp)) / (1000 * 60 * 60));
            if (hoursDiff >= 3 && hoursDiff <= 5) {
              newEntries.push({
                symbol: latest.symbol,
                price: latest.price,
                volume_now: latest.volume,
                volume_4h: earlier.volume,
                slug: latest.slug,
                timestamp: latest.timestamp
              });
            }
          }
        });

        // Artanlar
        topIncreases.sort((a, b) => b.percent - a.percent);
        const render = (data, selector) => {
          const tbody = document.querySelector(selector + ' tbody');
          tbody.innerHTML = '';
          data.slice(0, 10).forEach(c => {
            const row = `<tr>
              <td>${c.symbol}</td>
              <td>${Number(c.price).toFixed(4)}</td>
              <td>${Number(c.volume_now).toLocaleString()}</td>
              <td>${Number(c.volume_4h).toLocaleString()}</td>
              <td>${Number(c.volume_8h).toLocaleString()}</td>
              <td>${c.percent.toFixed(2)}%</td>
              <td><a href="https://coinmarketcap.com/currencies/${c.slug}/" target="_blank">Link</a></td>
              <td>${new Date(c.timestamp).toLocaleString()}</td>
            </tr>`;
            tbody.innerHTML += row;
          });
        };
        render(topIncreases, '#increaseTable');

        // DÃ¼ÅŸenler
        topDecreases.sort((a, b) => a.percent - b.percent);
        render(topDecreases, '#decreaseTable');

        // Yeni giriÅŸler
        const renderNewEntries = (data) => {
          const tbody = document.querySelector('#newTop200Table tbody');
          tbody.innerHTML = '';
          data.forEach(c => {
            const row = `<tr>
              <td>${c.symbol}</td>
              <td>${Number(c.price).toFixed(4)}</td>
              <td>${Number(c.volume_4h).toLocaleString()}</td>
              <td>${Number(c.volume_now).toLocaleString()}</td>
              <td><a href="https://coinmarketcap.com/currencies/${c.slug}/" target="_blank">Link</a></td>
              <td>${new Date(c.timestamp).toLocaleString()}</td>
            </tr>`;
            tbody.innerHTML += row;
          });
        };
        renderNewEntries(newEntries);
      });
  </script>
</body>
</html>
