<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Simulation – Liste</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px;max-width:1100px;margin:auto}
    a{color:inherit}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eee}
    th{cursor:pointer;text-align:left;white-space:nowrap}
    .muted{color:#6b7280}
    .toolbar{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    input,select{padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px}
  </style>
</head>
<body>
  <a href="/simulation/">← Geri</a>
  <h1 id="title">Liste</h1>
  <div class="toolbar">
    <label>Sırala:
      <select id="order">
        <option value="desc" selected>Yeni → Eski</option>
        <option value="asc">Eski → Yeni</option>
      </select>
    </label>
    <label>Limit:
      <input id="limit" type="number" min="1" max="1000" value="200" />
    </label>
    <button id="reload">Yenile</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th data-k="timestamp">Zaman</th>
        <th data-k="coin">Coin</th>
        <th data-k="price">Giriş</th>
        <th data-k="nprice">Çıkış</th>
        <th data-k="pnl">PnL %</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const qs = new URLSearchParams(location.search);
    const position = qs.get('position') || 'long';
    document.getElementById('title').textContent = position + ' – Kayıtlar';

    const orderSel = document.getElementById('order');
    const limitInp = document.getElementById('limit');
    const reloadBtn = document.getElementById('reload');

    let rows = [];
    let ascToggle = true;

    async function load(){
      const url = `/api/sim/list?position=${encodeURIComponent(position)}&order=${orderSel.value}&limit=${limitInp.value}`;
      const res = await fetch(url);
      rows = await res.json();
      render(rows);
    }

    function render(data){
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = data.map(r=>`
        <tr>
          <td>${new Date(r.timestamp).toLocaleString()}</td>
          <td>${r.coin}</td>
          <td>${Number(r.price).toFixed(6)}</td>
          <td>${r.nprice!=null?Number(r.nprice).toFixed(6):'-'}</td>
          <td>${r.pnl!=null?Number(r.pnl).toFixed(2):'-'}</td>
        </tr>
      `).join('');
    }

    function sortBy(k){
      ascToggle = !ascToggle;
      const dir = ascToggle ? 1 : -1;
      const sorted = [...rows].sort((a,b)=>{
        const A=a[k], B=b[k];
        if (A==null && B==null) return 0;
        if (A==null) return 1;
        if (B==null) return -1;
        if (k==='timestamp') return (new Date(A)-new Date(B))*dir;
        if (typeof A==='number' && typeof B==='number') return (A-B)*dir;
        return (''+A).localeCompare(''+B)*dir;
      });
      render(sorted);
    }

    document.querySelectorAll('th[data-k]').forEach(th=>{
      th.addEventListener('click', ()=>sortBy(th.dataset.k));
    });
    reloadBtn.addEventListener('click', load);

    load();
  </script>
</body>
</html>